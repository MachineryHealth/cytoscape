\section{多変量の確率関数}
\setcounter{exer}{0}
\setcounter{preexer}{1}
\label{multivar1}

\subsection{多変量の確率関数の定義}

確率関数は多変量に対しても拡張できる。今\(n\)個の確率変数\(X_{1},X_{2},\cdots,X_{n}\)を考えると、
確率関数\(P(X_{1}=x_{1},X_{2}=x_{2},\cdots,X_{n}=x_{n})\)は\(X_{1}=x_{1}\land X_{2}=x_{2}\land\cdots\wedge X_{n}=x_{n}\)
となる確率と定義される(以下の記号の意味はコラム\ref{logicallexist1}参照)。確率密度関数の方はどうなるだろうか。
まずは2変量で考えてみよう。
確率変数\(X, Y\)が従う確率密度関数を\(f(x,y)\)とすれば、節\ref{cont_dist1}(p.\pageref{pd_def1})で述べた確率密度関数の
性質を以下のように拡張できる。

\begin{enumerate}
\item 確率密度関数が取りうる値は全て0以上となる。すなわち、
\begin{equation}
\forall_{x}\forall_{y}f(x,y)\geq 0
\end{equation}
\item 確率変数が取りうる全範囲の確率の合計は1となる。すなわち、
\begin{equation}
\int^{+\infty}_{-\infty}\int^{+\infty}_{-\infty}f(x,y)dxdy=1
\end{equation}
\item \(X,Y\)が範囲\(D\)の値に収まる確率は以下の式で与えられる。
\begin{equation}
P((X,Y) \in D)=\int\int_{D}f(x,y)dxdy
\label{d3_1}
\end{equation}
\end{enumerate}

\begin{figure}
\refstepcounter{column}\label{logicallexist1}
\begin{itembox}[l]{コラム\thecolumn:基本的な論理記号}
\(\land\)は"かつ"(and)を、\(\lor\)は"または"(or)を表す。
\(\forall_{x} formula(x)\)は、考えうる全ての\(x=x_{1},x_{2},\cdots\)に対して\(formula(x)\)が成立するという意味を表し、
\(\exists_{x} formula(x)\)は、\(formula(x)\)を成立させるような\(x\)が存在するという意味を表す。
すなわち前者は\(formula(x_{1})\land formula(x_{2})\land \cdots\)を、後者は
\(formula(x_{1})\lor formula(x_{2})\lor \cdots\)を表す。
前者の記号\(\forall\)を全称限量記号、後者の記号\(\exists\)を存在限量記号という。
\end{itembox}
\vspace{1em}
\verb+ +
\end{figure}


\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/prob3D1}
\end{center}
\vspace{-2em}
\caption{3次元空間上の連続分布}
\label{prob3D1}
\end{figure}

図形的に表せば図\ref{prob3D1}のように、\(X,Y\)が領域\(D\)に入る確率は領域\(D\)と\(f(x,y)\)の部分で囲まれた空間の体積で表される。
すなわち、

\begin{equation}
P((x_{i} \leq X < x_{i}+\Delta x) \land (y_{j} \leq Y < y_{j}+\Delta y))\simeq f(x_{i},y_{j})\Delta x \Delta y
\label{eqn297}
\end{equation}

\noindent
領域\(D\)に\(\Delta x, \Delta y\)の長方形を互いに重ならないようにタイル
のように可能な限り敷き詰め、\(i\)番目の長方形の隅の座標を\(x_{i},y_{j} 
\in D\)として合計すると、\(\sum_{(x_{i},y_{j}) \in 
D}f(x_{i},y_{j})\Delta x \Delta y\)であり、\(\Delta x, \Delta y \to 0\)
のとき、式\ref{d3_1}に収束する。

これをさらに\(n\)変量で考えると、

\begin{enumerate}
\item 確率密度関数が取りうる値は必ず0以上となる。すなわち、全ての\(x_{1},x_{2},\cdots,x_{n}\)に対して\(f(x_{1},x_{2},\cdots,x_{n})\geq 0\)。
\item 確率変数が取りうる全範囲の確率の合計は1となる。すなわち、
\begin{equation}
\int^{x_{1}=+\infty}_{x_{1}=-\infty}\int^{x_{2}=+\infty}_{x_{2}=-\infty}\cdots\int^{x_{n}=+\infty}_{x_{n}=-\infty}f(x_{1},x_{2},\cdots,x_{n})dx_{1}dx_{2}\cdots dx_{n}=1
\label{d3_2_1}
\end{equation}
\item \(X_{1},X_{2},\cdots,X_{n}\)が範囲\(D\)の値に収まる確率は以下の式で与えられる。
\begin{equation}
P((X_{1},X_{2},\cdots,X_{n}) \in D)=\int\int\cdots\int_{D}f(x_{1},x_{2},\cdots,x_{n})dx_{1}dx_{2}\cdots dx_{n}
\label{d3_2_2}
\end{equation}
\end{enumerate}

\noindent
式\ref{d3_2_1}、\ref{d3_2_2}のいずれにおいても積分記号\(\int\)は\(n\)回登場することに注意されたい。

確率密度関数\(X \sim f(x),Y \sim g(y)\)について、

\begin{eqnarray}
P(x\leq X \leq x + \Delta x) \simeq f(x)\Delta x\nonumber\\
P(y\leq Y \leq y + \Delta y) \simeq g(y)\Delta y
\end{eqnarray}

\noindent
が成立するが、\(X\)と\(Y\)が独立な場合、

\begin{equation}
P((x\leq X \leq x + \Delta x) \land (y\leq Y \leq y + \Delta y))=f(x)\Delta x \cdot g(y)\Delta y=f(x)g(y)\Delta x \Delta y
\end{equation}

\noindent
となり、式\ref{eqn297}で\(f(x,y)=f(x)g(y)\)としたものに一致する。すなわち、\(f(x)g(y)\)は\(X,Y\)が従う結合密度関数である。


\subsection{畳み込み積分}
\label{convol12}

確率変数\(X\)と\(Y\)の和\(X+Y\)が従う確率密度関数\(h(z)\)は以下のように求めるこ
とができる。まず\(X \sim f(x), Y \sim g(y)\)とすると、その結合密度関数は、
\(f(x)g(y)\)である。\(a \leq X + Y \leq z\)となる確率は、\(h(z)\)の分布関数を\(H(z)\)とおくと、

\begin{equation}
P(a \leq X + Y \leq z)=H(z)-H(a)
\end{equation}

\noindent
と表すことができる。次に\(a \leq X + Y \leq z\)を満たす\(X\)と\(Y\)の範
囲を考えよう。\(Y\)が\(-\infty\)から\(+\infty\)まで自由に値を変えるとす
ると、\(X\)は\(a-Y \leq X \leq Z - Y\)という制約を受ける。この制約の中で
\(f(x)g(y)\)を積分すれば、\(P(a \leq X + Y \leq z)\)が求まる。すなわち
\(f(x)\)の分布関数を\(F(z)\)とおけば、

\begin{eqnarray}
P(a \leq X + Y \leq z)=H(z)-H(a)=\int_{y=-\infty}^{y=+\infty}\left\{\int_{x=a-y}^{x=z-y}f(x)dx\right\}g(y)dy\nonumber\\
=\int_{y=-\infty}^{y=+\infty}\left\{F(z-y)-F(a-y)\right\}g(y)dy\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \nonumber\\
=\int_{y=-\infty}^{y=+\infty}F(z-y)g(y)dy-\int_{y=-\infty}^{y=+\infty}F(a-y)g(y)dy 
\end{eqnarray}

\noindent
\(z\)を含む項、\(a\)を含む項だけを抜き出すと、

\begin{equation}
H(z)=\int_{y=-\infty}^{y=+\infty}F(z-y)g(y)dy, \ \ \ H(a)=\int_{y=-\infty}^{y=+\infty}F(a-y)g(y)dy
\end{equation}

\noindent
左の式について\(z\)で微分すると、

\begin{equation}
h(z)=\int_{-\infty}^{+\infty}f(z-y)g(y)dy
\label{eqn_convol1}
\end{equation}

\noindent
が求まる。式\ref{eqn_convol1}を\(f\)と\(g\)の{\bf 畳み込み積分(convolution)}\index{たたみこみせきぶん@畳み込み積分}という。

畳み込み積分を用いて\(N(\mu, \sigma^{2})\)に従う2つの確率変数\(X,Y\)の和\(X+Y\)が従う分布を求めよう。\(N(\mu, \sigma^{2})\)の
確率密度関数を\(f(x)\)として、\(X+Y\)の従う結合密度関数は、

\begin{eqnarray}
h(z) & = & \int_{-\infty}^{+\infty}f(z-y)f(y)dy=\int_{-\infty}^{+\infty}\frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(z-y-\mu)^{2}}{2\sigma^{2}}}\frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(y-\mu)^{2}}{2\sigma^{2}}}dy\nonumber\\
     & = & \frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{\frac{1}{2}(z-2\mu)^{2}}{2\sigma^{2}}}\cdot\int_{-\infty}^{+\infty}\frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{2(y-\frac{1}{2}z)^{2}}{2\sigma^{2}}}dy\nonumber\\
     & = & \frac{1}{\sqrt{2\pi}\sigma}e^{-\frac{(z-2\mu)^{2}}{4\sigma^{2}}}\cdot\frac{1}{\sqrt{2}}\int_{-\infty}^{+\infty}\frac{1}{\sqrt{2\pi}\frac{1}{\sqrt{2}}\sigma}e^{-\frac{(y-\frac{1}{2}z)^{2}}{2(\frac{1}{\sqrt{2}}\sigma)^{2}}}dy\nonumber\\
     & = & \frac{1}{\sqrt{2\pi}\sqrt{2}\sigma}e^{-\frac{(z-2\mu)^{2}}{2(\sqrt{2}\sigma)^{2}}}\cdot\int_{-\infty}^{+\infty}\frac{1}{\sqrt{2\pi}\frac{1}{\sqrt{2}}\sigma}e^{-\frac{(y-\frac{1}{2}z)^{2}}{2(\frac{1}{\sqrt{2}}\sigma)^{2}}}dy\nonumber\\
     & = & N(2\mu,2\sigma^{2})\mbox{の確率密度関数}\cdot N(\frac{1}{2}z,\frac{1}{2}\sigma^{2})\mbox{の全域に関する積分}\nonumber\\
     & = & N(2\mu,2\sigma^{2})\mbox{の確率密度関数}\cdot 1 = N(2\mu,2\sigma^{2})\mbox{の確率密度関数}
\end{eqnarray}

\noindent
となり、\(X+Y\)は\(N(2\mu,2\sigma^{2})\)に従うことが示された。

\vspace{1em}

\refstepcounter{exer}

\noindent
{\bf 問題\thesection-\theexer}:~\label{exer_nzmhard1} 畳み込み積分を用いて、サイコロルーレットを2回回したときに得られる数値の合計値が従う確率密度関数を求めよ。

\subsection{多変量の確率関数に関する期待値計算}

離散確率変数\(X\)が確率関数\(P(x)\)に従うとすれば、
その期待値は式\ref{eqn_expect327}で表される。
ここで\(X\)は\(n\)個の変数で定義される関数\(u\)で\(X=u(X_{1},X_{2},\cdots X_{n})\)と表され、
さらに\(X_{1},X_{2},\cdots X_{n}\)は確率関数\(P_{*}(x_{1},x_{2},\cdots x_{n})\)に
従うとする。このとき、\(E(X)\)を\(x_{1},x_{2},\cdots x_{n}\)で表してみよう。
与えられた条件のように、\(X\)が\(X_{1},X_{2},\cdots X_{n}\)のみによって一意に決まるならば、
\(X=x\)となる集合\(\{x_{1},x_{2},\cdots,x_{n}|u(x_{1},x_{2},\cdots,x_{n})=x\}\)が存在し、
その集合以外では\(X\neq x\)である。従って、

\begin{equation}
P(X=x)=\sum_{\{x_{1},x_{2},\cdots,x_{n}|u(x_{1},x_{2},\cdots,x_{n})=x\}}P_{*}(X_{1}=x_{1},X_{2}=x_{2},\cdots,X_{n}=x_{n})
\end{equation}

\noindent
が成立する。これを式\ref{eqn_expect327}に代入すると、

\begin{equation}
E(X)=\sum_{x}x\sum_{\{x_{1},x_{2},\cdots,x_{n}|u(x_{1},x_{2},\cdots,x_{n})=x\}}P_{*}(X_{1}=x_{1},X_{2}=x_{2},\cdots,X_{n}=x_{n})
\label{eq_multi_543}
\end{equation}

\noindent
ところで\(\sum_{x}\sum_{\{x_{1},x_{2},\cdots,x_{n}|u(x_{1},x_{2},\cdots,x_{n})=x\}}\)は
\(X_{1},X_{2},\cdots,X_{n}\)が取りうる値の組み合わせを\(u(x_{1},x_{2},\cdots,x_{n})=x\)ごとに
集めているに過ぎないから式\ref{eq_multi_543}は、

\begin{equation}
E(X)=\sum_{x_{1}}\sum_{x_{2}}\cdots\sum_{x_{n}}u(x_{1},x_{2},\cdots,x_{n}) P_{*}(X_{1}=x_{1},X_{2}=x_{2},\cdots,X_{n}=x_{n})
\label{eq_multi_544}
\end{equation}

\noindent
と書き直せる。ある関数\(h(x)\)に対して期待値\(E(h(X))\)は

\begin{equation}
E(h(X))=\sum_{x_{1}}\sum_{x_{2}}\cdots\sum_{x_{n}}h(u(x_{1},x_{2},\cdots,x_{n})) P_{*}(X_{1}=x_{1},X_{2}=x_{2},\cdots,X_{n}=x_{n})
\label{eq_multi_545}
\end{equation}

\noindent
となることは容易に想像できよう。

さて\(X\)が連続確率変数の場合はどうなるだろうか。
\(X\)が従う確率密度関数を\(f(x)\)とし、\(X_{1},X_{2},\cdots X_{n}\)が従う
確率密度関数を\(f_{*}(x)\)として議論を進めてみよう。もちろん\(u\)で\(X=u(X_{1},X_{2},\cdots X_{n})\)
を前提とする。
\(X_{1},X_{2},\cdots X_{n}\)が取りうる範囲を細かく
\(x_{1} \leq X_{1} < x_{1}+\Delta x_{1},\ 
x_{2} \leq X_{2} < x_{2}+\Delta x_{2},\ 
\cdots\ 
x_{n} \leq X_{n} < x_{n}+\Delta x_{n}\)
に分けると式\ref{eq_multi_544}は、

\begin{eqnarray}
E(X)& = & \sum_{x_{1}}\sum_{x_{2}}\cdots\sum_{x_{n}}u(x_{1},x_{2},\cdots,x_{n})
P_{*}(x_{1},x_{2},\cdots,x_{n})\nonumber\\
    & \simeq &
\sum_{x_{1}}\sum_{x_{2}}\cdots\sum_{x_{n}}u(x_{1},x_{2},\cdots,x_{n})
f_{*}(x_{1},x_{2},\cdots,x_{n})\Delta x_{1}\Delta x_{2}\cdots\Delta x_{n}
\label{eq_multi_546}
\end{eqnarray}

\noindent
\(\Delta x_{1},\Delta x_{2},\cdots,\Delta x_{n}\to 0\)のとき、式\ref{eq_multi_546}は

\begin{equation}
E(X)=\int_{-\infty}^{\infty}xf(x)dx=
\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}\cdots\int_{-\infty}^{\infty}u(x_{1},x_{2},\cdots, x_{n})f_{*}(x_{1},x_{2},\cdots x_{n})dx_{1}dx_{2}\cdots dx_{n}
\label{eq_multi_550}
\end{equation}

\noindent
に収束する\footnote{
これまでの議論を素直に数式にすると、\(X_{1},\cdots,X_{n}\)が取りうる値の範囲を\(D\)として、
\(E(X)=\int\int\cdots\int_{D}u(x_{1},\cdots, x_{n})f_{*}(x_{1},\cdots x_{n})dx_{1}\cdots dx_{n}\)となるが、
\(x_{1},\cdots x_{n}\)が取りえない値のところでは\(f_{*}(x_{1},\cdots x_{n})=0\)となるため、
積分範囲を無限大にしても差し支えない。
}。

ちなみに\(u(x_{1},x_{2},\cdots,x_{n})=u_{1}(x_{1})u_{2}(x_{2})\cdots u_{n}(x_{n})\)および
\(f_{*}(x_{1},x_{2},\cdots,x_{n})=f_{1}(x_{1})f_{2}(x_{2})\cdots f_{n}(x_{n})\)と積に分解されるときは、
\(E(X_{i})=\int_{-\infty}^{\infty}x_{i}f_{i}(x_{i})dx_{i}\)を式\ref{eq_multi_550}に代入して

\begin{equation}
E(X)=\Pi_{i=1}^{n}E(X_{i})=E(X_{1})E(X_{2})\cdots E(X_{n})
\label{eq_expect_prod105}
\end{equation}

\noindent
が成立する。

\subsection{多変量の確率密度関数の変数変換}

\begin{figure}
\begin{center}
\includegraphics[scale=0.6]{Figures/jacobian1}
\end{center}
\vspace{-2em}
\caption{2変数の変換のイメージ}
\label{jacobian1}
\end{figure}

\(x=\varphi(u,v)\),\(y=\psi(u,v)\)の関係が成立するとき、
図\ref{jacobian1}に示すように、
\((x,y)\)の定義域Dの1小領域P\(_{1}\)P\(_{2}\)P\(_{3}\)P\(_{4}\)とし、その内部の点Pがある。
上式によってP\(_{1}\)P\(_{2}\)P\(_{3}\)P\(_{4}\)がP\(_{1}'\)P\(_{2}'\)P\(_{3}'\)P\(_{4}'\)に移ったとする。
点P\(_{i}\)を$(x_{i},y_{i})$で表せば、偏微分の定義(式\ref{eqn_part_deriv1})である

\begin{displaymath}
\displaystyle \lim_{\Delta u\rightarrow 0}\frac{\varphi(u+\Delta u,v)-\varphi(u,v)}{\Delta u}=\frac{\partial\varphi}{\partial u}
\end{displaymath}

\noindent
や全微分(式\ref{eqn_total_deriv})を表す

\begin{displaymath}
\displaystyle \lim_{\Delta u\rightarrow 0}\lim_{\Delta v\rightarrow 0}\varphi(u+\Delta u,v+\Delta v)-\varphi(u,v)=\frac{\partial\varphi}{\partial u}\Delta u+\frac{\partial\varphi}{\partial v}\Delta v
\end{displaymath}

\noindent
などに注意して、

\begin{eqnarray}
x_{1} & = & \varphi(u,v)\nonumber\\
y_{1} & = & \psi(u,v)\nonumber\\
x_{2} & = & \varphi(u+\Delta u,v)=\varphi(u,v)+\frac{\partial\varphi}{\partial u}\Delta u\nonumber\\
y_{2} & = & \displaystyle \psi(u+\Delta u,v)=\psi(u,v)+\frac{\partial\psi}{\partial u}\Delta u\nonumber\\
x_{3} & = & \displaystyle \varphi(u+\Delta u,v+\Delta v)=\varphi(u,v)+\frac{\partial\varphi}{\partial u}\Delta u+\frac{\partial\varphi}{\partial v}\Delta v\nonumber\\
y_{3} & = & \displaystyle \psi(u+\Delta u,v+\Delta v)=\psi(u,v)+\frac{\partial\psi}{\partial u}\Delta u+\frac{\partial\psi}{\partial v}\Delta v\nonumber\\
x_{4} & = & \displaystyle \varphi(u+v+\Delta v)=\varphi(u,v)+\frac{\partial\varphi}{\partial v}\Delta v\nonumber\\
y_{4} & = & \displaystyle \psi(u+v+\Delta v)=\psi(u,v)+\frac{\partial\psi}{\partial v}\Delta v\nonumber\\
\end{eqnarray}

\noindent
平行四辺形の面積$\Delta S$は、

\begin{equation}
\left|\begin{array}{l}
\frac{\partial\varphi}{\partial u} \frac{\partial\varphi}{\partial v}\\
\frac{\partial\psi}{\partial u} \frac{\partial\psi}{\partial v}
\end{array}\right|\Delta u\Delta v=\frac{\partial(x,y)}{\partial(u,v)}\Delta u\Delta v=J\Delta u\Delta v
\end{equation}

\noindent
$J$はヤコビアン(Jacobian)と呼ばれる。
$\Delta S^{\prime}=\Delta u\Delta v$として、

\begin{equation}
\Delta S=|J|\Delta S^{\prime}
\end{equation}

\noindent
を得る。
$D$上で定義された$f(x,y)$の$x,y$に最初の式を代入すれば、$f(\varphi(u,v),\psi(u,v))$は$D^{\prime}$上の関数である。
$D^{\prime}$上の分割による小領域$\Delta S_{i}^{\prime}$に対し、$D$上の小領域$\Delta S$が対応するとすれば、

\begin{equation}
\sum_{i=1}^{n}f(x_{i},y_{i})\Delta S_{i}=\sum_{i=1}^{n}f(\varphi(u,v),\psi(u,v))|J|\Delta S_{i}^{\prime}
\end{equation}

\noindent
各$\Delta S_{i}^{\prime}\rightarrow 0$となる極限を考えれば、$x,y$は連続であるから、
\(\Delta S_{i}\rightarrow 0\)となり、

\begin{equation}
\int\int_{D}f(x,y)dxdy=\int\int_{D^{\prime}}f(\varphi(u,v),\psi(u,v))|J|dudv
\end{equation}

