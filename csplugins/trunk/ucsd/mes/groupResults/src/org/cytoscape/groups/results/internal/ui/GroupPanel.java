package org.cytoscape.groups.results.internal.ui;

// System imports
import java.awt.GridBagConstraints;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.List;

import javax.swing.JButton;
import javax.swing.JPanel;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;

import cytoscape.CyNetwork;
import cytoscape.CyNode;
import cytoscape.Cytoscape;
import cytoscape.groups.CyGroup;
import cytoscape.util.CyNetworkNaming;

/**
 * The GroupPanel is the implementation for the Cytopanel that presents the
 * group list mechanism to the user.
 */
public class GroupPanel extends JPanel implements ListSelectionListener,
		ActionListener {

	public GroupPanel() {
		super();

		initComponents();

		btnCreateMetaNode.addActionListener(this);
		btnCreateNetworkView.addActionListener(this);
		resultPanel.getTable().getSelectionModel().addListSelectionListener(
				this);
	}

	public void actionPerformed(ActionEvent e) {
		Object obj = e.getSource();
		if (obj instanceof JButton) {
			JButton btn = (JButton) obj;
			int selected = resultPanel.getTable().getSelectedRow();
			CyGroup group = (CyGroup) resultPanel.getTable().getModel()
					.getValueAt(selected, 1);
			if (btn == btnCreateMetaNode)
				createMetaNode(group);
			else if (btn == btnCreateNetworkView)
				createNetworkView(group);
		}
	}

	private void createMetaNode(CyGroup pGroup) {
		System.out.println("Create metaNode for group: "
				+ pGroup.getGroupName());
	}

	private void createNetworkView(CyGroup pGroup) {

		List<CyNode> nodes = pGroup.getNodes();
		List edges = pGroup.getInnerEdges();

		String newNetworkTitle = CyNetworkNaming
				.getSuggestedNetworkTitle(pGroup.getGroupName());
		CyNetwork new_network = Cytoscape.createNetwork(nodes, edges,
				newNetworkTitle);

		// Should we keep VS and node positions, if yes, we need a reference to
		// the parent network
		// CyNetworkView new_view =
		// Cytoscape.getNetworkView(new_network.getIdentifier());

		/*
		 * 
		 * if (new_view == Cytoscape.getNullNetworkView()) { return; }
		 * 
		 * String vsName = "default";
		 * 
		 * // keep the node positions Iterator i = new_network.nodesIterator();
		 * 
		 * while (i.hasNext()) { CyNode node = (CyNode) i.next();
		 * new_view.getNodeView(node)
		 * .setOffset(new_view.getNodeView(node).getXPosition(),
		 * new_view.getNodeView(node).getYPosition()); }
		 * 
		 * new_view.fitContent();
		 * 
		 * // Set visual style VisualStyle newVS = new_view.getVisualStyle();
		 * 
		 * if (newVS != null) { vsName = newVS.getName(); }
		 * 
		 * Cytoscape.getVisualMappingManager().setVisualStyle(vsName);
		 */

	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	// <editor-fold defaultstate="collapsed" desc=" Generated Code ">
	private void initComponents() {
		GridBagConstraints gridBagConstraints;

		pnlButtons = new javax.swing.JPanel();
		btnCreateMetaNode = new javax.swing.JButton();
		btnCreateNetworkView = new javax.swing.JButton();

		resultPanel = new GroupViewerPanel();

		setLayout(new java.awt.GridBagLayout());

		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
		gridBagConstraints.weightx = 1.0;
		gridBagConstraints.weighty = 1.0;
		gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
		add(resultPanel, gridBagConstraints);

		pnlButtons.setLayout(new java.awt.GridBagLayout());

		btnCreateMetaNode.setText("Create MetaNode");
		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.insets = new java.awt.Insets(10, 0, 10, 20);
		pnlButtons.add(btnCreateMetaNode, gridBagConstraints);

		btnCreateNetworkView.setText("Create Subnetwork");
		pnlButtons.add(btnCreateNetworkView, new java.awt.GridBagConstraints());

		gridBagConstraints = new java.awt.GridBagConstraints();
		gridBagConstraints.gridy = 1;
		gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
		add(pnlButtons, gridBagConstraints);

	}// </editor-fold>

	// Variables declaration - do not modify
	private javax.swing.JButton btnCreateMetaNode;
	private javax.swing.JButton btnCreateNetworkView;
	private javax.swing.JPanel pnlButtons;

	private GroupViewerPanel resultPanel;

	// End of variables declaration

	/**
	 * This is called when the user changes the selection
	 * 
	 * @param e
	 *            the event that caused us to be called
	 */
	public void valueChanged(ListSelectionEvent e) {
		if (e.getValueIsAdjusting() == false) {
			CyNetwork network = Cytoscape.getCurrentNetwork();
			// Reset selection state
			network.unselectAllNodes();
			int selected = resultPanel.getTable().getSelectedRow();
			CyGroup group = (CyGroup) resultPanel.getTable().getModel()
					.getValueAt(selected, 1);
			network.setSelectedNodeState(group.getNodes(), true);
			Cytoscape.getCurrentNetworkView().updateView();
		}
	}

	public void groupCreated(CyGroup group) {
		resultPanel.addGroup(group);
	}

	public void groupRemoved(CyGroup group) {
		resultPanel.removeGroup(group);
	}

	public void groupChanged(CyGroup group) {
		System.out.println("groupChanged event for group " + group.toString());
	}
}
