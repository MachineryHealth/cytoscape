/*****************************************************************************
 * Copyright (C) 2003-2005 Jean-Daniel Fekete and INRIA, France              *
 * ------------------------------------------------------------------------- *
 * This software is published under the terms of the X11 Software License    *
 * a copy of which has been included with this distribution in the           *
 * license-infovis.txt file.                                                 *
 *****************************************************************************/

import java.io.*;
import java.io.BufferedWriter;
import java.io.FileWriter;
import java.util.*;
import java.util.TreeMap;

import com.sun.javadoc.*;

/**
 * Class FactoryPropertiesGenerator
 * 
 * @author Jean-Daniel Fekete
 * @version $Revision: 1.6 $
 */
public class FactoryPropertiesGenerator {
    static TreeMap factories = new TreeMap();

    public static boolean start(RootDoc root) {
        String tagName = "infovis.factory";
        manageContents(root.classes(), tagName);
        generateProperties();
        return true;
    }

    private static void generateProperties() {
        for (Iterator fiter = factories.keySet().iterator(); fiter
                .hasNext();) {
            String factoryName = (String) fiter.next();
            String propName = factoryName.toLowerCase() + ".properties";
            TreeMap factoryMap = (TreeMap) factories.get(factoryName);
            try {
                int index = 0;
                FileWriter rout = new FileWriter("src/resources/"
                        + propName);
                BufferedWriter out = new BufferedWriter(rout);
                PrintWriter pout = new PrintWriter(out);
                pout.println("# This file is automatically generated DO NOT MODIFY!");

                for (Iterator iter = factoryMap.keySet().iterator(); iter
                        .hasNext();) {
                    String name = (String) iter.next();
                    String[] params = (String[]) factoryMap.get(name);
                    pout.println("name." + index + ":" + name);
                    pout.println("class." + index + ":" + params[0]);
                    for (int i = 2; i < params.length; i++) {
                        pout.println("data" + (i-1) + "." + index + ":"
                                + params[i]);
                    }
                    pout.println();
                    index++;
                }
                pout.close();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
    }

    private static String[] parsseLine(String text) {
        StringReader sin = new StringReader(text);
        StreamTokenizer stok = new StreamTokenizer(sin);
        stok.resetSyntax();
	stok.wordChars('!', '/');
	stok.wordChars('0', '9');
	stok.wordChars(':', '@');
        stok.wordChars('A', 'Z');
	stok.wordChars('[', '`');
        stok.wordChars('a', 'z');
        stok.wordChars('{', '~');
        stok.wordChars(131, 255);
        stok.whitespaceChars(0, ' ');
        stok.quoteChar('"');
        ArrayList al = new ArrayList();

        try {
            for (int tok = stok.nextToken(); tok != StreamTokenizer.TT_EOF; tok = stok
                    .nextToken()) {
                al.add(stok.sval);
            }
        } catch (IOException ex) {
            ex.printStackTrace();
        }
        String[] params = new String[al.size()];
        al.toArray(params);
        System.err.print("params=");
        for (int i = 0; i < params.length; i++) {
            System.err.print("\"" + params[i] + "\" ");
        }
        System.err.print("\n");
        return params;
    }

    private static void manageContents(ClassDoc[] classes,
            String tagName) {
        for (int i = 0; i < classes.length; i++) {
            Tag[] tags = classes[i].tags(tagName);
            if (tags.length > 0) {
                for (int k = 0; k < tags.length; k++) {
                    String text = tags[k].text();
                    String[] params = parsseLine(text);
                    if (params.length == 0) {
                        System.err
                                .println("Not enough arguments in @infovis.factory tag for "
                                        + classes[i].qualifiedName());
                        continue;
                    }
                    String factoryName = params[0];

                    TreeMap factoryMap = (TreeMap) factories
                            .get(factoryName);
                    if (factoryMap == null) {
                        factoryMap = new TreeMap();
                        factories.put(factoryName, factoryMap);
                    }
                    params[0] = classes[i].qualifiedName();
                    // 0=class name, 1=name, 2... extra params
                    if (params.length > 1) {
                        factoryMap.put(params[1], params);
                    }
                }
            }
        }
    }
}